# 操作系统

## 操作系统的启动

bios->bootloader->OS

bios basic io system 将bootloader从硬盘的引导扇区加载到0x7c00

bootloader 将操作系统的代码和数据从硬盘加载到内存

系统调用：来源于应用程序，应用程序主动向操作系统发出服务请求，异步或同步事件

异常：来源于不亮的应用程序，非法指令或者其他坏的处理状态，同步事件

中断：来源于外设，设备请求操作系统提供支持，异步事件

+ 响应
  - 中断：持续的，对应用程序透明
  - 异常：杀死或重新执行导致异常的指令
  - 系统调用：



内存碎片问题

内存分区的动态分配

首次分配：为了分配n个字节的空间，使用第一个可用空闲块

优点：简单

缺点：容易产生外部碎片

最优适配：为了分配n个字节的空间，使用最小的可用空闲块

优点：最大多数小内存分配高效，简单

缺点：外部碎片，重新分配慢

最差适配：为了分配n个字节的空间，使用最大的可用空闲块

避免产生太多微小的碎片

优点：分配中等尺寸最好，

缺点：易于破坏大的空间块，重新分配慢

### 3.4  连续内存分配：压缩式与交换式碎片整理

压缩式：移动程序的内存块，让其相对集中

交换式：某程序需要更多的内存块，内存中没有额外的空间时，将某个处于等待状态的程序的内存块回收（其内存内容转移到硬盘）

## 4 非连续内存分配

### 4.1 分段

优点：程序物理地址非连续，更好的内存管理，允许共享代码

缺点：如何建立虚拟地址与物理地址之间的转换

分段管理

连续的逻辑地址空间映射到非连续的物理地址空间

段访问机制：访问内存需要2维信息，段号和段内偏移

硬件实现方案：

### 4.2 分页

页的大小固定

帧（frame） 物理内存被分为大小相同的帧 ，物理内存地址由帧号和偏移决定

页（page）逻辑地址空间被分为大小相同的页，逻辑地址由页号和页内偏移决定

页寻址机制：页表实现页地址到帧地址的转换

页内偏移到帧内偏移的转换？？？？？

### 4.3 页表-概述、TLB

每个运行的程序都有一个页表：会动态变化，PTBR：页表基址寄存器

页表项内容：标志位+帧号

缺点：

1. 访问一次内存单元需要两次内存访问：访问页表项、访问数据

2. 页表可能非常大

解决办法：缓存，间接访问

Translation Look-aside Buffer (TLB)缓存近期访问的页帧转换表项，如果TLB被命中，物理页号可以很快被获取，如果TLB未被命中，对应的表项被更新到TLB中

### 4.4 页表-二级，多级页表

二级页表，将页号拆分为两张表来表示，可以降低页表空间

多级页表

时间换空间，多几页表的访问时间增加

### 4.5 页表-反向页表

反向页表，以帧号为索引建立页表

优点：页表的大小只跟物理内存大小相关，与逻辑地址无关，占用空间减少

缺点：如何索引

解决方案：

1. 关联内存

2. 基于hash查找的方案

   利用hash将大量的页号放入不同的桶内（即hash值相同的页号属于同一个筒），桶内的页号采用链表的方式存储，hash表中存储着不同桶内链表的头节点。根据页号对应的hash值在hash表中找到头节点，判断进程ID，如果不是当前进程的ID，转到下一个节点，同样判断PID。

### 5.1 虚拟内存的起因

registers 1nsec, <1kb

cache  2nsec,1MB

main memory 10nsec 64~512MB

magnetic disk 10msec, 5~50G

magnetic tape

如果程序太大，可以有以下技术：

+ 手动的覆盖（overlay），只把需要的指令和数据保存在内存中
+ 自动的交换（swapping），把暂时不执行的程序放到硬盘
+ 自动的虚拟存储技术

### 5.2 覆盖技术

把程序划分为相对独立的不同模块，不同模块之间没有调用关系，当然需要一个管理模块。

缺点：增加编程复杂度，内存与外存交互需要时间

### 5.3 交换技术

将暂时不运行的程序送到外存，从而获得空闲内存空间

需要解决的问题

+ 交换时机的确定，只有当内存空间不足时换出
+ 交换区的大小，
+ 程序换入时的重定位，

### 5.4 虚存技术

程序的局部性原理：程序在执行过程中的较短时间内，所执行的指定地址和指令的操作数地址分别局限于一定区域。

+ 在加载程序时，不必将其全部加载到内存中，只需将当前需要执行的部分页面加载到内存中
+ 在程序执行过程中，需要的指令或数据尚未在内存中（成为缺页活缺段），将相应页面加载到内存中，继续执行；
+ 另一方面，内存空间不足时，操作系统将暂时不使用的页面调出内存，从而腾出空间加载需要的指令和数据。

虚拟内存基本特征

+ 大的用户空间：
+ 部分交换
+ 不连续性：物理内存分配不连续，虚拟地址空间使用的不连续

虚拟页式内存管理

### 5.5 虚存技术

在页式存储管理的基础上，增加请求调页和页面置换功能。

页表项增加几个标识位：

+ 驻留位，
+ 保护位：读？写？执行？
+ 修改位：是否被写过（与硬盘中备份是否一致）
+ 访问位：是否被访问

缺页中断

1. 内存中是否有空闲物理页面，有则分配物理页帧，执行第4步；否则，执行第2步；
2. 采用某种页面置换算法，如果该页在内存期间被修改了，则需把它写回外存；
3. 将上一步被换出的页面的驻留位修改为0
4. 将需要的页面写入空闲页面

后备存储

虚拟内存性能

有效存储器访问时间EAT：内存访问时间\*页表命中几率+页中断处理时间\*页中断几率

内存访问时间：10ns

硬盘访问时间：5ms

页中断几率：p

dirty page几率：q（将页面换出的几率）

EAT = 10(1-p)+5000000p+5000000pq

### 6.1 最优页面置换算法

缺页中断发生，需要调入新的页面而内存已满，选择内存中那个物理页面被置换。

尽量减少页面的换进换出

最优页面置换算法

基本思路：当一个缺页中断发生时，计算内存中每一个页面的下一次访问等待时间，选择等待时间最长的那个，作为被置换的页面。

理想情况，无法实现。可以作为性能评价的依据。 

### 6.2 先进先出算法

First-In First-Out

基本思路：选择在内存中驻留时间最长的页面并淘汰之。

























